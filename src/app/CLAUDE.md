# app/ - Routes et pages

## Layout racine (layout.tsx)

- Langue : `fr`
- Font : Geist Sans + Geist Mono
- Structure : Sidebar (desktop) + MobileNav (mobile) + main content
- ThemeProvider (next-themes) : attribut `class`, défaut `system`
- UserProvider : fournit le contexte utilisateur authentifié à toute l'app
- Toaster (sonner) : position bottom-right, richColors

## Authentification

- **`(auth)/`** : Layout group pour les pages publiques (login, register). Layout minimal sans sidebar
  - **`login/`** : Formulaire de connexion (email + password). Supporte auth locale et LDAP
  - **`register/`** : Formulaire d'inscription (nom, email, password)
  - **`_actions/auth-actions.ts`** : `loginAction()`, `registerAction()`, `logoutAction()` -- gère auth locale + LDAP avec creation de session JWT
- **Middleware** (`src/proxy.ts`) : vérifie le cookie `access_token` (JWT) sur toutes les routes protegees. Redirige vers `/login` si absent, tente un refresh via `/api/auth/refresh` si expiré. Les routes `/login`, `/register`, `/api/*` et `/_next/*` sont exclues de la vérification

## Error Boundaries

| Fichier | Description |
|---------|-------------|
| `error.tsx` | Error boundary par route (reset + message d'erreur) |
| `global-error.tsx` | Error boundary global (erreurs dans le layout) |
| `not-found.tsx` | Page 404 personnalisée |
| `loading.tsx` | Skeleton de chargement global |

## Page d'accueil (page.tsx)

Dashboard avec cards de synthèse (reste à vivre, dépenses, revenus), liste des comptes avec solde (les comptes SAVINGS/INVESTMENT incluent les `baseAmount` des buckets), alertes de dépassement budget, dernières transactions et derniers virements.

Les données du dashboard sont fetchées via `src/app/_actions/dashboard-actions.ts` (8 requêtes en parallèle).

## Routes

| Route | Description | Paramètres URL |
|-------|-------------|----------------|
| `/transactions` | Vue mensuelle des transactions | `?month=2026-02&category=<id>` |
| `/transfers` | Virements inter-comptes du mois | `?month=2026-02` |
| `/budgets` | Budgets mensuels par catégorie | `?month=2026-02` |
| `/categories` | CRUD catégories et sous-catégories | - |
| `/accounts` | CRUD comptes et buckets | - |
| `/statistics` | Graphiques et analyses | `?year=2026&account=xxx` |
| `/settings` | Réglages (gestion token API) | - |
| `/admin` | Administration (liste utilisateurs, stats globales) -- `requireAdmin()` | - |

### Groupe auth (`(auth)/`)

| Route | Description |
|-------|-------------|
| `/login` | Formulaire de connexion |
| `/register` | Formulaire d'inscription |

### API REST (routes `/api/*`)

Endpoints pour intégrations externes (Tasker → n8n → API), sécurisés par Bearer token.

| Endpoint | Méthode | Description |
|----------|---------|-------------|
| `/api/transactions` | POST | Créer une transaction (body JSON) |
| `/api/categories` | GET | Lister catégories + sous-catégories |
| `/api/accounts` | GET | Lister les comptes |
| `/api/auth/refresh` | GET | Rafraichir le JWT access_token via le refresh_token cookie. Parametre `returnTo` pour redirect |

Auth : header `Authorization: Bearer <token>`. Token géré depuis `/settings`. `validateApiToken()` retourne le `userId` associé au token.

## Navigation

- **Sidebar** (desktop, >= md) : 9 liens (Accueil, Transactions, Virements, Budgets, Catégories, Comptes, Économies, Statistiques, Réglages) + toggle thème en bas
- **MobileNav** (mobile, < md) : Sheet latéral avec les mêmes liens
- **MonthNavigator** : composant dans `transactions/_components/` réutilisé par `/budgets` et `/transfers`, avec :
  - Flèches gauche/droite
  - Sélecteur de mois (dropdown 12 mois en français)
  - Sélecteur d'année (dropdown 2017 → année courante)
  - Bouton "Aujourd'hui" (masqué si déjà sur le mois courant)
  - Persistance du mois sélectionné via localStorage
- Le mois courant est le défaut si pas de paramètre `?month`

### Navigation inter-pages (catégorie → transactions)
- Les **cards catégories** (`/categories`) et les **cards budget** (`/budgets`) sont entièrement cliquables
- Clic → navigation vers `/transactions?category=<id>` avec le filtre de catégorie pré-sélectionné
- Effet hover : ombre + léger soulèvement (`hover:shadow-lg hover:-translate-y-0.5`)
- Les éléments interactifs (boutons edit/delete, input budget) restent cliquables indépendamment (z-index ou `stopPropagation`)

## Pattern des pages

Les pages sont des **Server Components async** qui :
1. Lisent les `searchParams` (await car Promise en Next.js 16)
2. Appellent les server actions pour fetch les données
3. Convertissent les Decimal/Date côté serveur
4. Passent des objets plain aux Client Components


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>