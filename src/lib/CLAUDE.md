# lib/ ‚Äî Utilitaires partag√©s

## Fichiers

### db/ (Drizzle ORM)
Module de base de donn√©es dual-provider (PostgreSQL / SQLite).

- **`schema/pg.ts`** : Sch√©ma PostgreSQL avec `pgTable`, `numeric(12,2)`, `date`, `timestamp`, `pgEnum`, relations, index
- **`schema/sqlite.ts`** : Sch√©ma SQLite avec `sqliteTable`, `real`, `text`, `integer({ mode: "boolean" })`, relations
- **`index.ts`** : Singleton dual-provider utilisant le pattern `globalThis`. Lit `DB_PROVIDER` au runtime pour choisir le driver (postgres.js ou better-sqlite3). Exporte `db` et toutes les tables.
- **`helpers.ts`** : `toNumber()` (string|number ‚Üí number), `toISOString()` (Date|string ‚Üí string), `toDecimal()`, `toDate()`
- **`seed.ts`** : Script de seed standalone (14 cat√©gories, 2 comptes, buckets, transactions d'exemple)

```typescript
import { db, accounts, transactions } from "@/lib/db";
import { eq, and, asc } from "drizzle-orm";
import { toNumber } from "@/lib/db/helpers";
```

### validators.ts
Sch√©mas Zod 4 centralis√©s pour toutes les entit√©s. Conventions :
- `z.coerce.number()` pour les champs FormData (string ‚Üí number)
- `z.preprocess()` pour transformer `""` en `null` (champs num√©riques optionnels comme `bucket.goal`)
- `.refine()` pour les contraintes cross-field (note obligatoire si transaction CANCELLED)
- Messages d'erreur en fran√ßais

| Sch√©ma | Particularit√©s |
|--------|---------------|
| `accountSchema` | `type` = enum 4 valeurs, `linkedAccountId` optionnel |
| `bucketSchema` | `goal` = preprocess `""` ‚Üí `null`, puis `number.nonnegative().nullable()` |
| `categorySchema` | Basique (nom, couleur, ic√¥ne, ordre) |
| `subCategorySchema` | `categoryId` requis |
| `transactionSchema` | `amount != 0`, `categoryId` requis, `date` optionnel (null si r√©current), `month`/`year` s√©par√©s, `isAmex` boolean, refine note si CANCELLED |
| `budgetSchema` | `month` 1-12, `year` 2000-2100 |

Types export√©s : `AccountInput`, `BucketInput`, `CategoryInput`, `SubCategoryInput`, `TransactionInput`, `BudgetInput`.

### formatters.ts
Fonctions de formatage avec locale fran√ßaise :

| Fonction | Description |
|----------|-------------|
| `formatCurrency(amount)` | `Intl.NumberFormat` EUR/fr-FR |
| `formatDate(date)` | `dd MMM yyyy` (ex: "15 janv. 2026") |
| `formatMonthYear(date)` | `MMMM yyyy` (ex: "janvier 2026") |
| `parseMonthParam(month?)` | Parse `"2026-02"` ‚Üí `{ year: 2026, month: 2 }`, d√©faut = mois courant |
| `toMonthParam(year, month)` | Inverse : `(2026, 2)` ‚Üí `"2026-02"` |

Constantes : `ACCOUNT_TYPE_LABELS`, `STATUS_LABELS` (maps string ‚Üí label fran√ßais).

### monthly-balance.ts
Gestion du report cumulatif inter-mois via la table `MonthlyBalance`.

| Fonction | Description |
|----------|-------------|
| `recomputeMonthlyBalance(year, month)` | Recalcule et upsert le surplus du mois (forecast - committed) |
| `getCarryOver(year, month)` | Retourne le report cumul√© = `SUM(surplus)` de tous les mois ant√©rieurs √† (year, month) |
| `backfillAllMonthlyBalances()` | Recalcule le surplus pour tous les mois distincts pr√©sents dans les transactions |

Appel√©e automatiquement apr√®s chaque mutation de transaction ou budget.

### api-auth.ts
Authentification des API routes REST par Bearer token.

| Fonction | Description |
|----------|-------------|
| `validateApiToken(request)` | Lit le header `Authorization: Bearer <token>`, v√©rifie en BDD, retourne `boolean` |
| `unauthorizedResponse()` | Retourne `NextResponse.json({ error: "Unauthorized" }, { status: 401 })` |

Utilis√© par toutes les routes `/api/*`. Le token est stock√© dans la table `api_tokens` et g√©r√© depuis `/settings`.

### utils.ts
Fonction `cn()` : merge de classes Tailwind via `clsx` + `twMerge` (standard Shadcn/UI).

## hooks/

### use-month-navigation.ts
Hook React pour la navigation mensuelle par URL searchParams avec **persistance localStorage**.

**Retourne** :
- `year`, `month` : mois courant pars√© depuis l'URL
- `monthParam` : format string `"2026-02"`
- `previousMonth()`, `nextMonth()` : navigation M-1 / M+1
- `navigateToMonth(year, month)` : navigation directe

**Comportement** :
- Lit le searchParam `?month=` de l'URL
- Si pas de searchParam mais localStorage contient un mois, redirige automatiquement
- Persiste le mois s√©lectionn√© dans localStorage √† chaque navigation

**Utilis√© par** : `MonthNavigator` (transactions et budgets).


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 23, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #574 | 11:13 AM | ‚úÖ | Deployed Monthly Balance Calculation Fix | ~318 |
| #572 | " | üî¥ | Fixed Monthly Balance Calculation to Filter CHECKING Accounts Only | ~534 |
| #569 | 11:04 AM | üî¥ | Fixed Account Filtering in Monthly Balance Calculation | ~491 |
</claude-mem-context>