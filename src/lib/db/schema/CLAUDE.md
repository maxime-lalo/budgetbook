# Schema Drizzle ORM (dual PostgreSQL / SQLite)

Deux fichiers de sch√©ma (`pg.ts` et `sqlite.ts`) avec les m√™mes tables et colonnes, adapt√©s au dialecte SQL.

## Architecture

- **Tables** : d√©finies avec `pgTable` / `sqliteTable` selon le provider
- **Relations** : d√©finies inline dans chaque fichier via `relations()` de drizzle-orm (pas de fichier partag√© -- n√©cessaire pour l'inf√©rence de types Drizzle)
- **FK constraints** : d√©finies via `foreignKey()` au niveau table (pas `.references()` sur les colonnes -- bug Drizzle #4308 qui casse l'inf√©rence de types des `one()` relations)
- **Index** : composites pour les requ√™tes fr√©quentes (year+month+status, accountId+status, etc.)

## Tables

| Table | Description | PK |
|-------|-------------|-----|
| `accounts` | Comptes bancaires (CHECKING, CREDIT_CARD, SAVINGS, INVESTMENT) | text id |
| `buckets` | Sous-comptes d'√©pargne (goal, baseAmount) | text id |
| `categories` | Cat√©gories de d√©penses (name unique, color) | text id |
| `subCategories` | Sous-cat√©gories (li√© √† category) | text id |
| `transactions` | Transactions financi√®res (montant, date, statut, etc.) | text id |
| `budgets` | Budgets mensuels par cat√©gorie | text id |
| `monthlyBalances` | Surplus mensuel mat√©rialis√© (forecast, committed, surplus) | text id |
| `apiTokens` | Tokens API hash√©s (token SHA-256, tokenPrefix 8 chars) | text id |
| `appPreferences` | Pr√©f√©rences app (amexEnabled, separateRecurring) -- singleton | text id |

## FK Constraints (via foreignKey() table-level)

| Source | Target | onDelete |
|--------|--------|----------|
| accounts.linkedAccountId | accounts.id | SET NULL |
| buckets.accountId | accounts.id | CASCADE |
| subCategories.categoryId | categories.id | CASCADE |
| transactions.accountId | accounts.id | RESTRICT |
| transactions.destinationAccountId | accounts.id | SET NULL |
| transactions.categoryId | categories.id | RESTRICT |
| transactions.subCategoryId | subCategories.id | SET NULL |
| transactions.bucketId | buckets.id | SET NULL |
| budgets.categoryId | categories.id | CASCADE |

## Diff√©rences PG vs SQLite

| Aspect | PostgreSQL | SQLite |
|--------|-----------|--------|
| Montants | `numeric(12,2)` (string) | `real` (number) |
| Dates | `date({ mode: "date" })` (Date) | `text` (string ISO) |
| Timestamps | `timestamp({ mode: "date" })` | `text` (string ISO) |
| Booleans | `boolean` | `integer({ mode: "boolean" })` |
| Enums | `pgEnum` | `text({ enum: [...] })` |

## Index composites

- `transactions_year_month_status_idx` -- requ√™tes mensuelles filtr√©es par statut
- `transactions_accountId_status_idx` -- soldes par compte
- `budgets_categoryId_year_month_key` -- unicit√© budget par cat√©gorie/mois (unique)
- `monthly_balances_year_month_key` -- unicit√© solde par mois (unique)


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 23, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #566 | 10:43 AM | üîµ | Financial Data Pipeline Architecture | ~560 |
</claude-mem-context>