# Schema Drizzle ORM (PostgreSQL)

Un seul fichier de sch√©ma (`pg.ts`) pour PostgreSQL.

## Architecture

- **Tables** : d√©finies avec `pgTable`
- **Relations** : d√©finies inline via `relations()` de drizzle-orm (pas de fichier partag√© -- n√©cessaire pour l'inf√©rence de types Drizzle)
- **FK constraints** : d√©finies via `foreignKey()` au niveau table (pas `.references()` sur les colonnes -- bug Drizzle #4308 qui casse l'inf√©rence de types des `one()` relations)
- **Index** : composites pour les requ√™tes fr√©quentes (year+month+status, accountId+status, etc.)
- **Multi-user** : toutes les tables de donnees ont une colonne `userId` (FK vers `users.id`, onDelete CASCADE)

## Tables

| Table | Description | PK |
|-------|-------------|-----|
| `users` | Utilisateurs (email unique, name, passwordHash, authProvider, isAdmin) | text id |
| `refreshTokens` | Refresh tokens JWT hash√©s (tokenHash, expiresAt) | text id |
| `accounts` | Comptes bancaires (CHECKING, CREDIT_CARD, SAVINGS, INVESTMENT) | text id |
| `buckets` | Sous-comptes d'√©pargne (goal, baseAmount) | text id |
| `categories` | Cat√©gories de d√©penses (name unique par user, color) | text id |
| `subCategories` | Sous-cat√©gories (li√© √† category) | text id |
| `transactions` | Transactions financi√®res (montant, date, statut, etc.) | text id |
| `budgets` | Budgets mensuels par cat√©gorie | text id |
| `monthlyBalances` | Surplus mensuel mat√©rialis√© (forecast, committed, surplus) | text id |
| `apiTokens` | Tokens API hash√©s (token SHA-256, tokenPrefix 8 chars) | text id |
| `appPreferences` | Pr√©f√©rences app (amexEnabled, separateRecurring) -- une par user | text id |

## FK Constraints (via foreignKey() table-level)

| Source | Target | onDelete |
|--------|--------|----------|
| refreshTokens.userId | users.id | CASCADE |
| accounts.userId | users.id | CASCADE |
| accounts.linkedAccountId | accounts.id | SET NULL |
| buckets.accountId | accounts.id | CASCADE |
| categories.userId | users.id | CASCADE |
| subCategories.userId | users.id | CASCADE |
| subCategories.categoryId | categories.id | CASCADE |
| transactions.userId | users.id | CASCADE |
| transactions.accountId | accounts.id | RESTRICT |
| transactions.destinationAccountId | accounts.id | SET NULL |
| transactions.categoryId | categories.id | RESTRICT |
| transactions.subCategoryId | subCategories.id | SET NULL |
| transactions.bucketId | buckets.id | SET NULL |
| budgets.userId | users.id | CASCADE |
| budgets.categoryId | categories.id | CASCADE |
| monthlyBalances.userId | users.id | CASCADE |
| apiTokens.userId | users.id | CASCADE |
| appPreferences.userId | users.id | CASCADE |

## Enums PostgreSQL

- `AccountType` : CHECKING, CREDIT_CARD, SAVINGS, INVESTMENT
- `TransactionStatus` : PENDING, COMPLETED, CANCELLED, PLANNED
- `AuthProvider` : local, ldap

## Index composites

- `transactions_year_month_status_idx` -- requ√™tes mensuelles filtr√©es par statut
- `transactions_accountId_status_idx` -- soldes par compte
- `budgets_userId_categoryId_year_month_key` -- unicit√© budget par user/cat√©gorie/mois (unique)
- `monthly_balances_userId_year_month_key` -- unicit√© solde par user/mois (unique)
- `categories_userId_name_key` -- unicit√© nom de cat√©gorie par user (unique)
- `refresh_tokens_userId_idx` -- recherche de tokens par user


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 23, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #566 | 10:43 AM | üîµ | Financial Data Pipeline Architecture | ~560 |
</claude-mem-context>